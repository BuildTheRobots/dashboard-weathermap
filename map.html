<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="1.0.0">
    <title>UK Weather Information Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrolling */
        }
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            transition: transform 0.3s ease-in-out;
        }
        .header-hidden {
            transform: translateY(-100%);
        }
        #header-trigger {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            z-index: 49;
        }
        .map-container, .info-container {
            height: calc(100vh + 40px); /* Overspill to hide iframe bottom bar */
            min-height: 540px;
        }
        #warnings-container::-webkit-scrollbar {
            width: 8px;
        }
        #warnings-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #warnings-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #warnings-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        #warnings-container strong {
            display: block;
            margin-bottom: 4px;
        }
    </style>
</head>
<body class="flex flex-col">

    <div id="header-trigger"></div>

    <header class="bg-white shadow-md w-full p-4">
        <h1 class="text-2xl font-bold text-gray-800 text-center">Live UK & Ireland Weather & Analysis</h1>
        <p class="text-center text-gray-500">Dynamic Weather Map Dashboard - v<span id="version-display">1.0.0</span></p>
        
        <!-- Settings Panel -->
        <div id="settings-panel" class="mt-4 p-4 border-t border-gray-200 text-sm">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Left Column Settings -->
                <div class="p-2 border rounded-lg bg-gray-50">
                    <h3 class="font-bold mb-2 text-gray-700">Left Column Carousel</h3>
                    <label class="block mb-1 font-medium text-gray-600">Maps (select one or more):</label>
                    <div id="left-maps-selection" class="h-32 overflow-y-auto border rounded p-2 bg-white mb-2"></div>
                    <label for="left-interval" class="block mb-1 font-medium text-gray-600">Rotation Interval (seconds):</label>
                    <input type="number" id="left-interval" class="w-full p-1 border rounded" min="5">
                </div>
                
                <!-- Right Column Settings -->
                <div class="p-2 border rounded-lg bg-gray-50">
                    <h3 class="font-bold mb-2 text-gray-700">Right Column Carousel</h3>
                    <label class="block mb-1 font-medium text-gray-600">Maps (select one or more):</label>
                    <div id="right-maps-selection" class="h-32 overflow-y-auto border rounded p-2 bg-white mb-2"></div>
                    <label for="right-interval" class="block mb-1 font-medium text-gray-600">Rotation Interval (seconds):</label>
                    <input type="number" id="right-interval" class="w-full p-1 border rounded" min="5">
                </div>

                <!-- Actions -->
                <div class="p-2 flex flex-col justify-center">
                    <button id="apply-settings-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Apply Changes</button>
                    <p class="text-xs text-gray-500 mt-2 text-center">Your settings are saved in this browser.</p>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow">
        <div id="dashboard-grid" class="grid grid-cols-1 lg:grid-cols-5 h-full">
            
            <!-- Left Column: Maps will be dynamically inserted here -->
            <div id="left-column" class="lg:col-span-2"></div>

            <!-- Right Column: Maps will be dynamically inserted here -->
            <div id="right-column" class="lg:col-span-2"></div>

            <!-- Information Column (static) -->
            <div class="shadow-lg overflow-hidden bg-white info-container lg:col-span-1 relative">
                <div class="h-full flex flex-col">
                    <h2 class="text-lg font-semibold text-white bg-purple-600 p-2 text-center flex-shrink-0">Analysis & Forecasts</h2>
                    <div class="flex-grow p-4 border-b flex flex-col">
                        <h3 class="text-md font-semibold text-center mb-2 text-gray-700 flex-shrink-0">UK Weather Warnings</h3>
                        <div id="warnings-container" class="w-full flex-grow rounded border p-2 overflow-y-auto bg-gray-50">
                            <p class="text-gray-500 text-center">Fetching latest warnings...</p>
                        </div>
                    </div>
                    <div class="absolute left-0 right-0 h-1/3" style="bottom: 40px;">
                         <div class="relative h-full flex flex-col">
                            <h3 class="absolute top-0 left-0 right-0 z-10 text-md font-semibold text-white bg-black/50 text-center p-1">Tropospheric Ducting Forecast</h3>
                            <div class="flex-grow rounded-t border-t border-l border-r overflow-hidden" 
                                  style="background-image: url('https://www.dxinfocentre.com/tr_map/fcst/nwe006.png'); background-size: 800px auto; background-position: -125px -160px; background-repeat: no-repeat;"
                                  role="img" aria-label="Tropospheric Ducting Map for North-West Europe, cropped to UK and Ireland"></div>
                            <div class="h-6 rounded-b border-b border-l border-r overflow-hidden flex-shrink-0" 
                                  style="background-image: url('https://www.dxinfocentre.com/tr_map/fcst/nwe006.png'); background-color: black; background-size: 800px auto; background-position: -300px -2px; background-repeat: no-repeat;"
                                  role="img" aria-label="Tropospheric Ducting Map Datestamp"></div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // --- APP LOGIC ---
        const App = {
            TRANSITION_DURATION: 700, // ms, matches CSS transition
            // --- DATA ---
            version: '1.0.0',
            VENTUSKY_MAPS: {
                // Precipitation Group (Blues/Purples)
                'rain-1h': { label: 'Rain (1h)', color: 'blue-800' },
                'rain-3h': { label: 'Rain (3h)', color: 'blue-700' },
                'radar': { label: 'Radar', color: 'indigo-600', holdTime: '+10' },
                'snow': { label: 'Snow Cover', color: 'sky-300' },
                'cape': { label: 'Thunderstorms', color: 'purple-600' },

                // Temperature Group (Reds/Oranges)
                'temperature-2m': { label: 'Temperature', color: 'red-600', holdTime: '15' },
                'feels-like': { label: 'Feels Like', color: 'orange-500' },

                // Wind Group (Greens/Teals)
                'wind-10m': { label: 'Wind Speed', color: 'green-600' },
                'wind-gust': { label: 'Wind Gusts', color: 'teal-500' },

                // Atmospheric/Other Group (Grays/Cyans)
                'pressure': { label: 'Air Pressure', color: 'rose-400' },
                'clouds': { label: 'Cloud Cover', color: 'slate-400' },
                'satellite': { label: 'Satellite', color: 'slate-500' },
                'humidity': { label: 'Humidity', color: 'cyan-500' },
                'aqi-us': { label: 'Air Quality (AQI)', color: 'stone-500' },

                // Water Group
                'waves': { label: 'Waves', color: 'blue-500' }
            },
            DEFAULT_SETTINGS: {
                left: { maps: [{key: 'rain-1h'}], interval: 30 },
                right: { maps: [{key: 'wind-10m'}, {key: 'wind-gust'}], interval: 30 }
            },
            settings: {},
            carouselIntervals: { left: null, right: null },

            // --- METHODS ---
            init() {
                document.getElementById('version-display').textContent = this.version;
                this.loadSettings();
                this.renderSettingsUI();
                this.renderDashboard();
                this.setupEventListeners();
                fetchWeatherWarnings(); // Also init static elements
                setInterval(fetchWeatherWarnings, 15 * 60 * 1000);
            },

            loadSettings() {
                const savedSettings = localStorage.getItem('weatherMapSettings');
                let settings;
                try {
                    settings = savedSettings ? JSON.parse(savedSettings) : structuredClone(this.DEFAULT_SETTINGS);
                } catch (e) {
                    console.error("Failed to parse settings from localStorage, using defaults.", e);
                    settings = structuredClone(this.DEFAULT_SETTINGS);
                }
                // Migration for old settings format
                if (settings.left && Array.isArray(settings.left.maps) && settings.left.maps.length > 0 && typeof settings.left.maps[0] === 'string') {
                    settings.left.maps = settings.left.maps.map(key => ({ key }));
                }
                if (settings.right && Array.isArray(settings.right.maps) && settings.right.maps.length > 0 && typeof settings.right.maps[0] === 'string') {
                    settings.right.maps = settings.right.maps.map(key => ({ key }));
                }

                this.settings = settings;
            },

            saveSettings() {
                localStorage.setItem('weatherMapSettings', JSON.stringify(this.settings));
            },

            renderSettingsUI() {
                const renderMapSettings = (containerId, mapsConfig) => {
                    const container = document.getElementById(containerId);
                    container.innerHTML = '';
                    for (const [key, value] of Object.entries(this.VENTUSKY_MAPS)) {
                        const config = mapsConfig.find(m => m.key === key);
                        const isChecked = !!config;
                        const holdTime = config ? (config.holdTime || '') : '';
                        const checkboxId = `${containerId}-${key}`;
                        const holdTimeInputId = `${containerId}-holdtime-${key}`;

                        container.innerHTML += `
                            <div class="flex items-center justify-between mb-1" data-map-key="${key}">
                                <div class="flex items-center">
                                    <input type="checkbox" id="${checkboxId}" class="form-checkbox h-4 w-4 text-blue-600" ${isChecked ? 'checked' : ''}>
                                    <label for="${checkboxId}" class="ml-2 text-gray-700">${value.label}</label>
                                </div>
                                <input type="text" id="${holdTimeInputId}" value="${holdTime}" placeholder="e.g. +10, 25" class="w-24 p-1 border rounded text-xs" ${!isChecked ? 'disabled' : ''}>
                            </div>
                        `;
                    }

                    container.querySelectorAll('input[type=checkbox]').forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            const parentDiv = e.target.closest('[data-map-key]');
                            const holdTimeInput = parentDiv.querySelector('input[type=text]');
                            holdTimeInput.disabled = !e.target.checked;
                        });
                    });
                };

                renderMapSettings('left-maps-selection', this.settings.left.maps);
                document.getElementById('left-interval').value = this.settings.left.interval;
                renderMapSettings('right-maps-selection', this.settings.right.maps);
                document.getElementById('right-interval').value = this.settings.right.interval;
            },

            renderDashboard() {
                this.renderColumn('left', this.settings.left);
                this.renderColumn('right', this.settings.right);
            },

            renderColumn(colName, colSettings) {
                const container = document.getElementById(`${colName}-column`);
                if (!colSettings || !colSettings.maps || colSettings.maps.length === 0) {
                    container.innerHTML = ''; // Clear column if no maps are selected
                    return;
                }

                const mapData = colSettings.maps.map(mapConfig => ({ ...this.VENTUSKY_MAPS[mapConfig.key], ...mapConfig }));

                container.innerHTML = `
                    <div id="${colName}-map-container" class="shadow-lg overflow-hidden relative h-full border-8 border-transparent transition-colors duration-700">
                        <div id="${colName}-frame-0" class="absolute inset-0 transition-opacity ease-in-out" style="opacity: 0; transition-duration: ${this.TRANSITION_DURATION}ms;"></div>
                        <div id="${colName}-frame-1" class="absolute inset-0 transition-opacity ease-in-out" style="opacity: 0; transition-duration: ${this.TRANSITION_DURATION}ms;"></div>
                    </div>
                `;

                if (mapData.length > 0) {
                    this.setupCarousel(colName, colSettings.interval * 1000, mapData);
                }
            },

            createMapFrameHTML(map) {
                const url = `https://embed.ventusky.com/?p=55.2;-4.0;5&l=${map.key}`;
                return `
                    <div class="map-container h-full">
                        <iframe src="${url}" class="w-full h-full border-0" frameborder="0" title="${map.label}" onload="this.dataset.loaded = 'true'"></iframe>
                    </div>
                    <h2 class="absolute top-0 left-0 right-0 text-lg font-semibold text-white bg-${map.color}/50 p-2 text-center z-10">${map.label}</h2>
                `;
            },

            setupCarousel(colName, interval, mapData) {
                if (this.carouselIntervals[colName]) {
                    clearTimeout(this.carouselIntervals[colName]);
                }

                const mapContainer = document.getElementById(`${colName}-map-container`);
                const frames = [
                    document.getElementById(`${colName}-frame-0`),
                    document.getElementById(`${colName}-frame-1`)
                ];
                
                const showNextMap = (currentMapIndex, currentFrameIndex) => {
                    const nextMapIndex = (currentMapIndex + 1) % mapData.length;
                    const nextMap = mapData[nextMapIndex];
                    const nextFrameIndex = 1 - currentFrameIndex;
                    
                    const currentFrame = frames[currentFrameIndex];
                    const nextFrame = frames[nextFrameIndex];

                    // Update border color
                    if (mapContainer.dataset.currentColor) {
                        mapContainer.classList.remove(`border-${mapContainer.dataset.currentColor}`);
                    }
                    mapContainer.classList.add(`border-${nextMap.color}`);
                    mapContainer.dataset.currentColor = nextMap.color;

                    nextFrame.innerHTML = this.createMapFrameHTML(nextMap);
                    const iframe = nextFrame.querySelector('iframe');

                    const scheduleNext = () => {
                        if (mapData.length <= 1) return;

                        const holdTime = nextMap.holdTime;
                        let nextInterval = interval;

                        if (holdTime) {
                            const parsedTime = parseInt(holdTime, 10);
                            if (!isNaN(parsedTime)) {
                                if (typeof holdTime === 'string' && (holdTime.startsWith('+') || holdTime.startsWith('-'))) {
                                    nextInterval = interval + (parsedTime * 1000);
                                } else {
                                    nextInterval = parsedTime * 1000;
                                }
                            }
                        }
                        
                        if (nextInterval < 5000) nextInterval = 5000;

                        this.carouselIntervals[colName] = setTimeout(() => showNextMap(nextMapIndex, nextFrameIndex), nextInterval);
                    };

                    const transition = () => {
                        nextFrame.style.opacity = 1;
                        if (currentFrame) currentFrame.style.opacity = 0;
                        
                        setTimeout(() => {
                            scheduleNext();
                            if (currentFrame) {
                                currentFrame.innerHTML = '';
                            }
                        }, this.TRANSITION_DURATION);
                    };

                    // Use iframe.onload to ensure the map is ready before we transition to it.
                    if (iframe.dataset.loaded === 'true') {
                        transition();
                    } else {
                        iframe.onload = transition;
                    }
                };

                // Initial load
                showNextMap(-1, 1);
            },

            setupEventListeners() {
                document.getElementById('apply-settings-btn').addEventListener('click', () => {
                    const getMapsConfig = (containerId) => {
                        const maps = [];
                        document.querySelectorAll(`#${containerId} [data-map-key]`).forEach(div => {
                            const checkbox = div.querySelector('input[type=checkbox]');
                            if (checkbox.checked) {
                                const key = div.dataset.mapKey;
                                const holdTimeInput = div.querySelector('input[type=text]');
                                const holdTime = holdTimeInput.value.trim();
                                const mapConfig = { key };
                                if (holdTime) {
                                    mapConfig.holdTime = holdTime;
                                }
                                maps.push(mapConfig);
                            }
                        });
                        return maps;
                    };

                    this.settings.left.maps = getMapsConfig('left-maps-selection');
                    this.settings.left.interval = document.getElementById('left-interval').value;
                    this.settings.right.maps = getMapsConfig('right-maps-selection');
                    this.settings.right.interval = document.getElementById('right-interval').value;

                    this.saveSettings();
                    this.renderDashboard();
                });

                // Header hiding logic
                const header = document.querySelector('header');
                const headerTrigger = document.getElementById('header-trigger');
                const initialHideTimeout = setTimeout(() => header.classList.add('header-hidden'), 10000);
                headerTrigger.addEventListener('mouseenter', () => {
                    header.classList.remove('header-hidden');
                    clearTimeout(initialHideTimeout);
                });
                header.addEventListener('mouseleave', () => header.classList.add('header-hidden'));
            }
        };

        // --- STATIC HELPERS ---
        function fetchWeatherWarnings() {
            const warningsContainer = document.getElementById('warnings-container');
            const feedUrl = 'https://www.metoffice.gov.uk/public/data/PWSCache/WarningsRSS/Region/UK';
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            
            fetch(proxyUrl + encodeURIComponent(feedUrl))
                .then(response => response.ok ? response.text() : Promise.reject('Network response was not ok'))
                .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
                .then(data => {
                    warningsContainer.innerHTML = '';
                    const items = data.querySelectorAll("item");
                    if (items.length === 0) {
                        warningsContainer.innerHTML = '<p class="text-gray-500 text-center">No active weather warnings.</p>';
                        return;
                    }
                    items.forEach(item => {
                        const title = item.querySelector("title").textContent;
                        const descriptionHTML = item.querySelector("description").textContent;
                        let bgColor = 'bg-gray-200', textColor = 'text-gray-800';
                        if (title.toLowerCase().includes('yellow')) { bgColor = 'bg-yellow-300'; }
                        if (title.toLowerCase().includes('amber')) { bgColor = 'bg-amber-400'; }
                        if (title.toLowerCase().includes('red')) { bgColor = 'bg-red-500'; textColor = 'text-white';}
                        const warningEl = document.createElement('div');
                        warningEl.className = `p-2 mb-2 rounded shadow-sm text-sm ${bgColor} ${textColor}`;
                        warningEl.innerHTML = descriptionHTML;
                        const link = warningEl.querySelector('a');
                        if (link) link.remove();
                        warningsContainer.appendChild(warningEl);
                    });
                })
                .catch(err => {
                    console.error("Error fetching weather warnings:", err);
                    warningsContainer.innerHTML = '<p class="text-red-500 text-center">Could not load warnings.</p>';
                });
        }

        // --- START APP ---
        document.addEventListener('DOMContentLoaded', () => App.init());

    </script>

</body>
</html>
