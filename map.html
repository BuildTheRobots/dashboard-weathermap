<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Weather Information Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrolling */
        }
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            transition: transform 0.3s ease-in-out;
        }
        .header-hidden {
            transform: translateY(-100%);
        }
        #header-trigger {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 40px;
            z-index: 49;
        }
        .map-container, .info-container {
            height: calc(100vh + 40px); /* Overspill to hide iframe bottom bar */
            min-height: 540px;
        }
        #warnings-container::-webkit-scrollbar {
            width: 8px;
        }
        #warnings-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #warnings-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #warnings-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        #warnings-container strong {
            display: block;
            margin-bottom: 4px;
        }
    </style>
</head>
<body class="flex flex-col">

    <div id="header-trigger"></div>

    <header class="bg-white shadow-md w-full p-4">
        <h1 class="text-2xl font-bold text-gray-800 text-center">Live UK & Ireland Weather & Analysis</h1>
        <p class="text-center text-gray-500">Dynamic Weather Map Dashboard</p>
        
        <!-- Settings Panel -->
        <div id="settings-panel" class="mt-4 p-4 border-t border-gray-200 text-sm">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Left Column Settings -->
                <div class="p-2 border rounded-lg bg-gray-50">
                    <h3 class="font-bold mb-2 text-gray-700">Left Column Carousel</h3>
                    <label class="block mb-1 font-medium text-gray-600">Maps (select one or more):</label>
                    <div id="left-maps-selection" class="h-32 overflow-y-auto border rounded p-2 bg-white mb-2"></div>
                    <label for="left-interval" class="block mb-1 font-medium text-gray-600">Rotation Interval (seconds):</label>
                    <input type="number" id="left-interval" class="w-full p-1 border rounded" min="5">
                </div>
                
                <!-- Right Column Settings -->
                <div class="p-2 border rounded-lg bg-gray-50">
                    <h3 class="font-bold mb-2 text-gray-700">Right Column Carousel</h3>
                    <label class="block mb-1 font-medium text-gray-600">Maps (select one or more):</label>
                    <div id="right-maps-selection" class="h-32 overflow-y-auto border rounded p-2 bg-white mb-2"></div>
                    <label for="right-interval" class="block mb-1 font-medium text-gray-600">Rotation Interval (seconds):</label>
                    <input type="number" id="right-interval" class="w-full p-1 border rounded" min="5">
                </div>

                <!-- Actions -->
                <div class="p-2 flex flex-col justify-center">
                    <button id="apply-settings-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Apply Changes</button>
                    <p class="text-xs text-gray-500 mt-2 text-center">Your settings are saved in this browser.</p>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow">
        <div id="dashboard-grid" class="grid grid-cols-1 lg:grid-cols-5 h-full">
            
            <!-- Left Column: Maps will be dynamically inserted here -->
            <div id="left-column" class="lg:col-span-2"></div>

            <!-- Right Column: Maps will be dynamically inserted here -->
            <div id="right-column" class="lg:col-span-2"></div>

            <!-- Information Column (static) -->
            <div class="shadow-lg overflow-hidden bg-white info-container lg:col-span-1 relative">
                <div class="h-full flex flex-col">
                    <h2 class="text-lg font-semibold text-white bg-purple-600 p-2 text-center flex-shrink-0">Analysis & Forecasts</h2>
                    <div class="flex-grow p-4 border-b flex flex-col">
                        <h3 class="text-md font-semibold text-center mb-2 text-gray-700 flex-shrink-0">UK Weather Warnings</h3>
                        <div id="warnings-container" class="w-full flex-grow rounded border p-2 overflow-y-auto bg-gray-50">
                            <p class="text-gray-500 text-center">Fetching latest warnings...</p>
                        </div>
                    </div>
                    <div class="absolute left-0 right-0 h-1/3" style="bottom: 40px;">
                         <div class="relative h-full flex flex-col">
                            <h3 class="absolute top-0 left-0 right-0 z-10 text-md font-semibold text-white bg-black/50 text-center p-1">Tropospheric Ducting Forecast</h3>
                            <div class="flex-grow rounded-t border-t border-l border-r overflow-hidden" 
                                  style="background-image: url('https://www.dxinfocentre.com/tr_map/fcst/nwe006.png'); background-size: 800px auto; background-position: -125px -160px; background-repeat: no-repeat;"
                                  role="img" aria-label="Tropospheric Ducting Map for North-West Europe, cropped to UK and Ireland"></div>
                            <div class="h-6 rounded-b border-b border-l border-r overflow-hidden flex-shrink-0" 
                                  style="background-image: url('https://www.dxinfocentre.com/tr_map/fcst/nwe006.png'); background-color: black; background-size: 800px auto; background-position: -300px -2px; background-repeat: no-repeat;"
                                  role="img" aria-label="Tropospheric Ducting Map Datestamp"></div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // --- APP LOGIC ---
        const App = {
            // --- DATA ---
            VENTUSKY_MAPS: {
                'rain-1h': { label: 'Rain (1h)', color: 'blue-900' },
                'rain-3h': { label: 'Rain (3h)', color: 'blue-800' },
                'radar': { label: 'Radar', color: 'indigo-900' },
                'satellite': { label: 'Satellite', color: 'gray-500' },
                'wind-10m': { label: 'Wind Speed', color: 'green-700' },
                'wind-gust': { label: 'Wind Gusts', color: 'teal-700' },
                'temperature-2m': { label: 'Temperature', color: 'red-600' },
                'feels-like': { label: 'Feels Like', color: 'orange-600' },
                'pressure': { label: 'Air Pressure', color: 'purple-700' },
                'clouds': { label: 'Cloud Cover', color: 'gray-600' },
                'humidity': { label: 'Humidity', color: 'cyan-600' },
                'waves': { label: 'Waves', color: 'blue-500' },
                'snow': { label: 'Snow Cover', color: 'light-blue-300' },
                'cape': { label: 'Thunderstorms', color: 'yellow-600' },
                'aqi-us': { label: 'Air Quality (AQI)', color: 'gray-700' }
            },
            DEFAULT_SETTINGS: {
                left: { maps: ['rain-1h'], interval: 30 },
                right: { maps: ['wind-10m', 'wind-gust'], interval: 30 }
            },
            settings: {},
            carouselIntervals: { left: null, right: null },

            // --- METHODS ---
            init() {
                this.loadSettings();
                this.renderSettingsUI();
                this.renderDashboard();
                this.setupEventListeners();
                fetchWeatherWarnings(); // Also init static elements
                setInterval(fetchWeatherWarnings, 15 * 60 * 1000);
            },

            loadSettings() {
                const savedSettings = localStorage.getItem('weatherMapSettings');
                this.settings = savedSettings ? JSON.parse(savedSettings) : JSON.parse(JSON.stringify(this.DEFAULT_SETTINGS));
            },

            saveSettings() {
                localStorage.setItem('weatherMapSettings', JSON.stringify(this.settings));
            },

            renderSettingsUI() {
                const renderCheckboxes = (containerId, selectedMaps) => {
                    const container = document.getElementById(containerId);
                    container.innerHTML = '';
                    for (const [key, value] of Object.entries(this.VENTUSKY_MAPS)) {
                        const isChecked = selectedMaps.includes(key);
                        const checkboxId = `${containerId}-${key}`;
                        container.innerHTML += `
                            <div class="flex items-center">
                                <input type="checkbox" id="${checkboxId}" data-map-key="${key}" class="form-checkbox h-4 w-4 text-blue-600" ${isChecked ? 'checked' : ''}>
                                <label for="${checkboxId}" class="ml-2 text-gray-700">${value.label}</label>
                            </div>
                        `;
                    }
                };
                renderCheckboxes('left-maps-selection', this.settings.left.maps);
                document.getElementById('left-interval').value = this.settings.left.interval;
                renderCheckboxes('right-maps-selection', this.settings.right.maps);
                document.getElementById('right-interval').value = this.settings.right.interval;
            },

            renderDashboard() {
                this.renderColumn('left', this.settings.left);
                this.renderColumn('right', this.settings.right);
            },

            renderColumn(colName, colSettings) {
                const container = document.getElementById(`${colName}-column`);
                if (!colSettings || !colSettings.maps || colSettings.maps.length === 0) {
                    container.innerHTML = ''; // Clear column if no maps are selected
                    return;
                }

                const carouselId = `${colName}-carousel`;
                const mapData = colSettings.maps.map(key => ({ key, ...this.VENTUSKY_MAPS[key] }));
                const primaryColor = mapData[0].color || 'gray-700';

                let slidesHTML = '';
                mapData.forEach((map, index) => {
                    slidesHTML += this.createSlideHTML(map, index);
                });
                // Add a clone of the first slide for seamless looping if there's more than one slide
                if (mapData.length > 1) {
                    slidesHTML += this.createSlideHTML(mapData[0], mapData.length);
                }

                container.innerHTML = `
                    <div class="shadow-lg overflow-hidden relative h-full ring-8 ring-${primaryColor}/50">
                        <div id="${carouselId}" class="relative w-full h-full transition-transform duration-700 ease-in-out">
                            ${slidesHTML}
                        </div>
                    </div>
                `;

                if (mapData.length > 1) {
                    this.setupCarousel(carouselId, colSettings.interval * 1000, mapData.length);
                }
            },

            createSlideHTML(map, index) {
                const url = `https://embed.ventusky.com/?p=55.2;-4.0;5&l=${map.key}`;
                return `
                    <div class="absolute w-full h-full" style="top: ${index * 100}%;">
                        <div class="map-container h-full">
                            <iframe src="${url}" class="w-full h-full border-0" frameborder="0" title="${map.label}"></iframe>
                        </div>
                        <h2 class="absolute top-0 left-0 right-0 text-lg font-semibold text-white bg-${map.color}/50 p-2 text-center z-10">${map.label}</h2>
                    </div>
                `;
            },

            setupCarousel(carouselId, interval, slideCount) {
                const colName = carouselId.split('-')[0];
                if (this.carouselIntervals[colName]) {
                    clearInterval(this.carouselIntervals[colName]);
                }

                const carousel = document.getElementById(carouselId);
                if (!carousel) return;

                let currentIndex = 0;
                this.carouselIntervals[colName] = setInterval(() => {
                    currentIndex++;
                    carousel.style.transition = 'transform 0.7s ease-in-out';
                    carousel.style.transform = `translateY(-${currentIndex * 100}%)`;
                }, interval);

                carousel.addEventListener('transitionend', () => {
                    if (currentIndex >= slideCount) {
                        carousel.style.transition = 'none';
                        currentIndex = 0;
                        carousel.style.transform = 'translateY(0%)';
                        carousel.offsetHeight; // Force reflow
                        carousel.style.transition = 'transform 0.7s ease-in-out';
                    }
                });
            },

            setupEventListeners() {
                document.getElementById('apply-settings-btn').addEventListener('click', () => {
                    const getSelectedMaps = (containerId) => {
                        const maps = [];
                        document.querySelectorAll(`#${containerId} input[type=checkbox]:checked`).forEach(el => {
                            maps.push(el.dataset.mapKey);
                        });
                        return maps;
                    };

                    this.settings.left.maps = getSelectedMaps('left-maps-selection');
                    this.settings.left.interval = document.getElementById('left-interval').value;
                    this.settings.right.maps = getSelectedMaps('right-maps-selection');
                    this.settings.right.interval = document.getElementById('right-interval').value;

                    this.saveSettings();
                    this.renderDashboard();
                });

                // Header hiding logic
                const header = document.querySelector('header');
                const headerTrigger = document.getElementById('header-trigger');
                const initialHideTimeout = setTimeout(() => header.classList.add('header-hidden'), 10000);
                headerTrigger.addEventListener('mouseenter', () => {
                    header.classList.remove('header-hidden');
                    clearTimeout(initialHideTimeout);
                });
                header.addEventListener('mouseleave', () => header.classList.add('header-hidden'));
            }
        };

        // --- STATIC HELPERS ---
        function fetchWeatherWarnings() {
            const warningsContainer = document.getElementById('warnings-container');
            const feedUrl = 'https://www.metoffice.gov.uk/public/data/PWSCache/WarningsRSS/Region/UK';
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            
            fetch(proxyUrl + encodeURIComponent(feedUrl))
                .then(response => response.ok ? response.text() : Promise.reject('Network response was not ok'))
                .then(str => new window.DOMParser().parseFromString(str, "text/xml"))
                .then(data => {
                    warningsContainer.innerHTML = '';
                    const items = data.querySelectorAll("item");
                    if (items.length === 0) {
                        warningsContainer.innerHTML = '<p class="text-gray-500 text-center">No active weather warnings.</p>';
                        return;
                    }
                    items.forEach(item => {
                        const title = item.querySelector("title").textContent;
                        const descriptionHTML = item.querySelector("description").textContent;
                        let bgColor = 'bg-gray-200', textColor = 'text-gray-800';
                        if (title.toLowerCase().includes('yellow')) { bgColor = 'bg-yellow-300'; }
                        if (title.toLowerCase().includes('amber')) { bgColor = 'bg-amber-400'; }
                        if (title.toLowerCase().includes('red')) { bgColor = 'bg-red-500'; textColor = 'text-white';}
                        const warningEl = document.createElement('div');
                        warningEl.className = `p-2 mb-2 rounded shadow-sm text-sm ${bgColor} ${textColor}`;
                        warningEl.innerHTML = descriptionHTML;
                        const link = warningEl.querySelector('a');
                        if (link) link.remove();
                        warningsContainer.appendChild(warningEl);
                    });
                })
                .catch(err => {
                    console.error("Error fetching weather warnings:", err);
                    warningsContainer.innerHTML = '<p class="text-red-500 text-center">Could not load warnings.</p>';
                });
        }

        // --- START APP ---
        document.addEventListener('DOMContentLoaded', () => App.init());

    </script>

</body>
</html>

